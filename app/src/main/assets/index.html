<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Images</title>

        <script>
            const API_BASE_URL = 'http://10.0.2.2:5000'

            function displayImages() {
                fetch('/images/list')
                    .then(response => response.json())
                    .then(data => {
                        const images = data.images || [];
                        const imageListContainer = document.getElementById('image-list');

                        if (images.length > 0) {
                            let imageListHtml = '<ul>';
                            images.forEach(image => {
                                // Display the image with its filename and dimensions
                                imageListHtml += `<li>
                                                    <img src="/images?${image.contentUri}" alt="${image.name}" width="150" height="150">
                                                    <br><strong>${image.name}</strong>
                                                    <br>Dimensions: ${image.width}x${image.height}
                                                    </li>`;
                            });
                            imageListHtml += '</ul>';
                            imageListContainer.innerHTML = imageListHtml;
                        } else {
                            imageListContainer.innerHTML = '<p>No images found.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching images:', error);
                    });
            }

            function displayVideos() {
                fetch('/videos/list')
                    .then(response => response.json())
                    .then(data => {
                        const videos = data.videos || [];
                        const videoListContainer = document.getElementById('video-list');

                        if (videos.length > 0) {
                            let videoListHtml = '<ul>';
                            videos.forEach(video => {
                                // Display the video with its filename and dimensions
                                videoListHtml += `<li>
                                                    <video controls src="/videos?${video.contentUri}" alt="${video.name}" width="150" height="150">
                                                        Your browser does not support the video tag.
                                                    </video>
                                                    <br><strong>${video.name}</strong>
                                                    <br>Size: ${video.size}
                                                    </li>`;
                            });
                            videoListHtml += '</ul>';
                            videoListContainer.innerHTML = videoListHtml;
                        } else {
                            videoListContainer.innerHTML = '<p>No videos found.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching videos:', error);
                    });
            }

            function sendImages() {
                // Fetch the list of images from the server
                fetch('/images/list')
                    .then(response => response.json())
                    .then(data => {
                        const images = data.images || [];  // Get the images from the response

                        if (images.length > 0) {
                            images.forEach(image => {
                                console.log("Sending image:", image.name);  // Log the filename

                                // Fetch the image stream from the Phone API using the content URI
                                fetch(`/images?${image.contentUri}`)
                                    .then(response => response.blob())  // Convert the image stream to a Blob
                                    .then(imageBlob => {
                                        // Create a FormData object to send the image as binary data
                                        const formData = new FormData();
                                        formData.append('image', imageBlob, image.name);  // Use the name as the file name

                                        // Send the image as FormData to the second API (outside the emulator)
                                        const request = `${API_BASE_URL}/image/send`;
                                        fetch(request, {
                                            method: 'POST',
                                            body: formData
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            console.log('Image sent successfully:', data);
                                        })
                                        .catch(error => {
                                            console.error('Error sending image:', error);
                                        });
                                    })
                                    .catch(error => {
                                        console.error('Error fetching image stream:', error);
                                    });
                            });
                        } else {
                            console.log('No images to send.');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching image list:', error);
                    });
            }

            function sendVideos() {
                // Fetch the list of videos from the server
                fetch('/videos/list')
                    .then(response => response.json())
                    .then(data => {
                        const videos = data.videos || [];  // Get the videos from the response

                        if (videos.length > 0) {
                            videos.forEach(video => {
                                console.log("Sending video:", video.name);  // Log the filename

                                // Fetch the video stream from the Phone API using the content URI
                                fetch(`/videos?${video.contentUri}`)
                                    .then(response => response.blob())  // Convert the video stream to a Blob
                                    .then(videoBlob => {
                                        // Create a FormData object to send the video as binary data
                                        const formData = new FormData();
                                        formData.append('video', videoBlob, video.name);  // Use the name as the file name

                                        // Send the video as FormData to the second API (outside the emulator)
                                        const request = `${API_BASE_URL}/video/send`;
                                        fetch(request, {
                                            method: 'POST',
                                            body: formData
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            console.log('Video sent successfully:', data);
                                        })
                                        .catch(error => {
                                            console.error('Error sending video:', error);
                                        });
                                    })
                                    .catch(error => {
                                        console.error('Error fetching video stream:', error);
                                    });
                            });
                        } else {
                            console.log('No videos to send.');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching video list:', error);
                    });
            }

            function testConnection() {
                const request = `${API_BASE_URL}/test`;
                fetch(request)
                    .then(response => {
                        console.log('Response status:', response.status);  // Log status
                        return response.json();
                    })
                    .then(data => {
                        console.log('Test response:', data);
                        alert('Connection to second API is working!');
                    })
                    .catch(error => {
                        console.error('Error testing connection:', error);
                        alert('Error connecting to second API.');
                    });
            }

            function displayFunction() {
                displayImages();
                displayVideos();
            }

            // Load images and video when the page is loaded
            window.onload = displayFunction;
        </script>
    </head>

    <body>
        <h1>Images in snapmedia Directory</h1>

        <!-- Button to reload images -->
        <button onclick="displayFunction()">Reload Media</button>

        <!-- Button to send images to second API -->
        <button onclick="sendImages()">Send Images to Second API</button>

        <!-- Button to send videos to second API -->
        <button onclick="sendVideos()">Send Videos to Second API</button>

        <!-- Button to test connection with the second API -->
        <button onclick="testConnection()">Test Connection to Second API</button>

        <br><br>
        <h5>Images</h5>
        <div id="image-list">Loading images...</div>


        <br><br>
        <h5>Videos</h5>
        <div id="video-list">Loading Videos...</div>

    </body>
</html>
